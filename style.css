let currentExamQuestions = [];
let currentIndex = 0;
let userAnswers = [];

// 1. ë¬¸ì œ ìˆ˜ ë²„íŠ¼ ì„¤ì •
const countBtns = document.querySelectorAll('.count-select button');
countBtns.forEach(btn => {
    btn.onclick = () => {
        countBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };
});

// 2. ì‹œí—˜ ì‹œì‘
document.getElementById('startBtn').onclick = () => {
    const activeBtn = document.querySelector('.count-select button.active');
    if (!activeBtn) return alert("ë¬¸ì œ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");

    const count = parseInt(activeBtn.dataset.count);
    currentExamQuestions = [...window.questions].sort(() => Math.random() - 0.5).slice(0, count);
    currentIndex = 0;
    userAnswers = new Array(count).fill(null);

    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('exam-screen').classList.remove('hidden');
    showQuestion();
};

// 3. ë¬¸ì œ ì¶œë ¥ ë° í´ë¦­
function showQuestion() {
    const q = currentExamQuestions[currentIndex];
    document.getElementById('progress').innerText = `${currentIndex + 1} / ${currentExamQuestions.length}`;
    document.getElementById('question-title').innerText = q.title;

    const optionsList = document.getElementById('options');
    optionsList.innerHTML = '';

    q.options.forEach(opt => {
        const li = document.createElement('li');
        li.innerText = opt;
        if (userAnswers[currentIndex] === opt) li.classList.add('selected');
        li.onclick = () => {
            userAnswers[currentIndex] = opt;
            document.querySelectorAll('#options li').forEach(el => el.classList.remove('selected'));
            li.classList.add('selected');
        };
        optionsList.appendChild(li);
    });

    // ì¤‘ë„ í¬ê¸°/ì œì¶œ ë²„íŠ¼ ë³´ì´ê¸° (ë§ˆì§€ë§‰ ë¬¸ì œê°€ ì•„ë‹ˆì–´ë„ ì œì¶œ ê°€ëŠ¥)
    const isLast = currentIndex === currentExamQuestions.length - 1;
    document.getElementById('nextBtn').classList.toggle('hidden', isLast);
}

// 4. ë„¤ë¹„ê²Œì´ì…˜ ë° ì¤‘ë„ ì œì¶œ
document.getElementById('nextBtn').onclick = () => { currentIndex++; showQuestion(); };
document.getElementById('prevBtn').onclick = () => { currentIndex--; showQuestion(); };
document.getElementById('submitBtn').onclick = () => finishExam(); // ì¤‘ë„ í¬ê¸° ë° ìµœì¢… ì œì¶œ ê³µìš©

// 5. ê²°ê³¼ ë¶„ì„ í•µì‹¬ ë¡œì§
function finishExam() {
    if (!confirm("ì‹œí—˜ì„ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    let score = 0;
    const stats = {}; // ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
    const wrongList = []; // ì˜¤ë‹µë…¸íŠ¸ ë°ì´í„°

    currentExamQuestions.forEach((q, idx) => {
        const isCorrect = userAnswers[idx] === q.answer;
        
        // í†µê³„ ê³„ì‚°
        if (!stats[q.category]) stats[q.category] = { total: 0, correct: 0 };
        stats[q.category].total++;
        if (isCorrect) {
            score++;
            stats[q.category].correct++;
        } else {
            // ì˜¤ë‹µë…¸íŠ¸ ì¶”ê°€
            wrongList.push({
                title: q.title,
                user: userAnswers[idx] || "ë¯¸ì„ íƒ",
                correct: q.answer,
                explanation: q.explanation
            });
        }
    });

    renderResults(score, stats, wrongList);
}

// 6. ê²°ê³¼ í™”ë©´ ë Œë”ë§
function renderResults(score, stats, wrongList) {
    document.getElementById('exam-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    
    document.getElementById('score').innerText = `ì´ ${currentExamQuestions.length}ë¬¸ì œ ì¤‘ ${score}ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤!`;

    // ì¹´í…Œê³ ë¦¬ë³„ ì •ë‹µë¥ 
    const statDiv = document.getElementById('category-stats');
    statDiv.innerHTML = '<h4>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì •ë‹µë¥ </h4>';
    for (const cat in stats) {
        const rate = Math.round((stats[cat].correct / stats[cat].total) * 100);
        statDiv.innerHTML += `
            <div class="stat-item">
                <span>${cat}</span>
                <span>${rate}% (${stats[cat].correct}/${stats[cat].total})</span>
            </div>`;
    }

    // ì˜¤ë‹µ ë…¸íŠ¸
    const noteDiv = document.getElementById('wrong-notes');
    noteDiv.innerHTML = '<h4>âŒ ì˜¤ë‹µ ë…¸íŠ¸</h4>';
    if (wrongList.length === 0) {
        noteDiv.innerHTML += '<p>ëª¨ë“  ë¬¸ì œë¥¼ ë§íˆì…¨ìŠµë‹ˆë‹¤! ì™„ë²½í•´ìš”!</p>';
    } else {
        wrongList.forEach(w => {
            noteDiv.innerHTML += `
                <div class="wrong-item">
                    <div class="wrong-title">${w.title}</div>
                    <div style="color:#e74c3c; font-size:0.9rem;">ë‚´ ì„ íƒ: ${w.user}</div>
                    <div class="wrong-ans">ì •ë‹µ: ${w.correct}</div>
                    <div class="wrong-exp">í•´ì„¤: ${w.explanation}</div>
                </div>`;
        });
    }
}
